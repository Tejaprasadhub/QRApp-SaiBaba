<div class="new-sales-wrapper">
  <h2 class="page-title">ðŸ›’ New Sale</h2>

  <div class="sales-container">

    <!-- ================= PRODUCT LIST ================= -->
    <div class="products-panel">
      <div class="panel-header">
        <h4>Products</h4>
        <input
          type="text"
          placeholder="Search products..."
          [(ngModel)]="productSearch"
          class="search-input"
          (ngModelChange)="onSearchChange()"
        />
      </div>

      <div class="filters">
        <label>Category:</label>
        <select [(ngModel)]="selectedCategory" (change)="loadProducts()">
          <option value="">All</option>
          <option *ngFor="let cat of getCategories()" [value]="cat">{{ cat }}</option>
        </select>
      </div>

      <div class="products-list">
        <div
          class="product-card"
          *ngFor="let p of products"
          [ngClass]="{ 'low-stock': isLowStock(p), 'out-of-stock': !canAddToCart(p) }"
        >
          <div class="product-info">
            <h5>{{ p?.name }}</h5>
            <p>Stock: {{ p?.stock }}</p>
            <p>Cost: â‚¹{{ p?.price }}</p>
            <p *ngIf="p?.categoryName">Category: {{ p?.categoryName }}</p>
            <p *ngIf="p?.subcategoryName">Sub Category: {{ p?.subcategoryName }}</p>
          </div>
          <button class="btn-add" (click)="addToCart(p)" [disabled]="!canAddToCart(p)">
            {{ canAddToCart(p) ? 'Add' : 'Out of stock' }}
          </button>
        </div>
      </div>

      <div class="pagination">
        <button (click)="loadNextPage()" [disabled]="!lastDoc">Load More</button>
      </div>
    </div>

    <!-- ================= CART PANEL ================= -->
    <div class="cart-panel">
      <h4>ðŸ§¾ Cart</h4>

      <!-- Customer Search -->
      <div class="customer-box">
        <label>Customer Phone:</label>
        <!-- <input
          type="text"
          [(ngModel)]="customerPhone"
          placeholder="Enter phone number"
          (change)="loadCustomerByPhone()"
        /> -->

        
  <input
    type="tel"
    name="customerPhone"
    [(ngModel)]="customerPhone"
    placeholder="Enter 10-digit phone number"
    pattern="^[6-9][0-9]{9}$"
    maxlength="10"
    #phoneCtrl="ngModel"
    (ngModelChange)="loadCustomerByPhone()"
    required
  />

  <!-- Validation messages -->
  <div class="error" *ngIf="phoneCtrl.invalid && phoneCtrl.touched">
    <small *ngIf="phoneCtrl.errors?.['required']">Phone number is required</small>
    <small *ngIf="phoneCtrl.errors?.['pattern']">Enter a valid 10-digit phone number</small>
  </div>

        <div *ngIf="customerData" class="customer-info">
          <div class="customer-name-box">
  <label><b>Name:</b></label>
  <input
    type="text"
    [(ngModel)]="customerData.name"
    placeholder="Enter customer name"
    [disabled]="phoneCtrl?.invalid ?? true"
  />
</div>

          <p><b>Total Pending:</b> â‚¹{{ customerData.totalPendingAmount || 0 }}</p>
        </div>
      </div>

      <div *ngIf="cart.length === 0" class="empty-cart">Cart is empty</div>

      <div class="cart-items" *ngFor="let c of cart">
        <div class="cart-item-header">
          <b>{{ c.name }}</b>
          <span>(x{{ c.qty }})</span>
        </div>

        <p *ngIf="c?.categoryName">Category: {{ c?.categoryName }}</p>
        <p *ngIf="c?.subcategoryName">Sub Category: {{ c?.subcategoryName }}</p>

        <div class="cart-item-body">
          <label>Selling Price:</label>
          <input
            type="number"
            [(ngModel)]="c.sellingPrice"
            (ngModelChange)="recalc()"
            min="0"
          />
          <span>= â‚¹{{ c.sellingPrice * c.qty }}</span>
        </div>

        <button class="btn-remove" (click)="removeFromCart(c)">Remove</button>
      </div>

      <div class="cart-summary">
        <div class="payment-box">
  <label>Payment Mode</label>

  <select [(ngModel)]="paymentMode">
    <option value="cash">Cash (Full)</option>
    <option value="credit">Credit (No payment)</option>
    <option value="partial">Partial</option>
  </select>

  <div *ngIf="paymentMode === 'partial'">
    <label>Paid Amount</label>
    <input
      type="number"
      [(ngModel)]="paidAmount"
      min="0"
      [max]="total"
      placeholder="Enter paid amount"
    />
  </div>
</div>

        <div>Total: <b>â‚¹{{ total }}</b></div>

        <button class="btn-checkout"  (click)="checkout()">Checkout</button>
      </div>
    </div>

  </div>
</div>
