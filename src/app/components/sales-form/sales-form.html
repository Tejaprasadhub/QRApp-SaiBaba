<div class="new-sales-wrapper">
  <h2 class="page-title">ðŸ›’ New Sale</h2>

  <div class="sales-container">
    <!-- ================= PRODUCT LIST ================= -->
    <div class="products-panel">
      <div class="panel-header">
        <h4>Products</h4>
        <input
          type="text"
          placeholder="Search products..."
          [(ngModel)]="productSearch"
          class="search-input"
          (ngModelChange)="onSearchChange()"
        />
      </div>

      <div class="filters">
        <label>Category:</label>
        <select [(ngModel)]="selectedCategory" (change)="loadProducts()">
          <option value="">All</option>
          <option *ngFor="let cat of getCategories()" [value]="cat">{{ cat }}</option>
        </select>
      </div>

      <div class="products-list">
        <div
          class="product-card"
          *ngFor="let p of products"
          [ngClass]="{ 'low-stock': isLowStock(p), 'out-of-stock': !canAddToCart(p) }"
        >
          <div class="product-info">
            <h5>{{ p?.name }}</h5>
            <p>Stock: {{ p?.stock }}</p>
            <p>Cost: â‚¹{{ p?.price }}</p>
            <p *ngIf="p?.categoryName">Category: {{ p?.categoryName }}</p>
            <p *ngIf="p?.subcategoryName">Sub Category: {{ p?.subcategoryName }}</p>
          </div>
          <button
            class="btn-add"
            (click)="addToCart(p)"
            [disabled]="!canAddToCart(p)"
          >
            {{ canAddToCart(p) ? 'Add' : 'Out of stock' }}
          </button>
        </div>
      </div>

      <!-- Load More button for pagination -->
      <div class="pagination">
        <button (click)="loadNextPage()" [disabled]="!lastDoc">Load More</button>
      </div>
    </div>

    <!-- ================= CART PANEL ================= -->
    <div class="cart-panel">
      <h4>ðŸ§¾ Cart</h4>

      <div *ngIf="cart.length === 0" class="empty-cart">Cart is empty</div>

      <div class="cart-items" *ngFor="let c of cart">
        <div class="cart-item-header">
          <b>{{ c.name }}</b> <span>(x{{ c.qty }})</span>           
        </div>
        <p *ngIf="c?.categoryName">Category: {{ c?.categoryName }}</p>
        <p *ngIf="c?.subcategoryName">Sub Category: {{ c?.subcategoryName }}</p>
        <div class="cart-item-body">
          <label>Selling Price:</label>
          <input
            type="number"
            [(ngModel)]="c.sellingPrice" 
            (ngModelChange)="recalc()"
            min="0"
          />
          <span>= â‚¹{{ c.sellingPrice * c.qty }}</span>
        </div>
        <button class="btn-remove" (click)="removeFromCart(c)">Remove</button>
      </div>

      <div class="cart-summary">
        <div>Total: <b>â‚¹{{ total }}</b></div>
        <input [(ngModel)]="customer" placeholder="Customer name (optional)" />
        <button class="btn-checkout" (click)="checkout()">Checkout</button>
      </div>
    </div>
  </div>
</div>
