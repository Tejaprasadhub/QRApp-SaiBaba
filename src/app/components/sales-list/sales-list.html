<div class="sales-wrapper">

  <!-- Header -->
  <div class="sales-header">
    <h2>Sales Dashboard</h2>
    <div class="header-actions">
      <button class="btn-filter" (click)="toggleFilters()">
        <i class="pi pi-filter"></i> Filters
      </button>
      <a routerLink="/sales/add" class="btn-new-sale">New Sale</a>
    </div>
  </div>

  <!-- Filters (toggleable) -->
  <div class="sales-filters" *ngIf="showFilters">
    <input [(ngModel)]="filterCustomer" placeholder="Customer Name" (input)="applyFilters()" class="filter-input">
    <input type="date" [(ngModel)]="filterFromDate" (change)="applyFilters()" class="filter-input">
    <input type="date" [(ngModel)]="filterToDate" (change)="applyFilters()" class="filter-input">
  </div>

  <!-- Summary Cards -->
  <div class="sales-summary">
    <div class="summary-card">
      <h3>Total Sales</h3>
      <p>₹{{ totalSales | number:'1.0-2' }}</p>
    </div>
    <div class="summary-card">
      <h3>Total Profit</h3>
      <p>₹{{ totalProfit | number:'1.0-2' }}</p>
    </div>
  </div>

  <!-- Sales Table (desktop) -->
  <div class="sales-table-wrapper desktop-table">
    <table class="sales-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Customer</th>
          <th>Items</th>
          <th>Total Items</th>
          <th>Total Amount</th>
          <th>Profit</th>
          <th>Payment</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let s of paginatedSales">
          <td>{{ getFormattedDate(s.date) | date:'medium' }}</td>
          <td>{{ s.customer || 'Walk-in' }}</td>
          <td>
            <ul class="item-list">
              <li *ngFor="let i of s.items">
                {{ i.name }} x {{ i.qty }} | Cost ₹{{ i.costPrice || 0 }} | Sold ₹{{ i.sellingPrice || i.price }} |
                <strong [ngClass]="{'profit-positive': ((i.sellingPrice || i.price) - (i.costPrice || 0)) * i.qty > 0,
                                     'profit-negative': ((i.sellingPrice || i.price) - (i.costPrice || 0)) * i.qty <= 0}">
                  Profit ₹{{ ((i.sellingPrice || i.price) - (i.costPrice || 0)) * i.qty }}
                </strong>
              </li>
            </ul>
          </td>
          <td>{{ getTotalItems(s) }}</td>
          <td>₹{{ s.total }}</td>
          <td [ngClass]="{'profit-positive': getSaleProfit(s) > 0, 'profit-negative': getSaleProfit(s) <= 0}">
            ₹{{ getSaleProfit(s) | number:'1.0-2' }}
          </td>
          <td>{{ s.paymentMode || 'Cash' }}</td>
        </tr>
        <tr *ngIf="!filteredSales.length">
          <td colspan="7" class="no-data">No sales found.</td>
        </tr>
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button [disabled]="currentPage===1" (click)="goToPage(currentPage-1)">Prev</button>
      <button *ngFor="let p of [].constructor(totalPages); let i = index" 
              [class.active]="currentPage===i+1" (click)="goToPage(i+1)">
        {{ i+1 }}
      </button>
      <button [disabled]="currentPage===totalPages" (click)="goToPage(currentPage+1)">Next</button>
    </div>
  </div>

  <!-- Mobile Cards -->
  <div class="mobile-table" *ngIf="paginatedSales.length">
    <div *ngFor="let s of paginatedSales" class="sale-card">
      <div class="sale-header">
        <div>{{ getFormattedDate(s.date) | date:'medium' }}</div>
        <div>{{ s.customer || 'Walk-in' }}</div>
      </div>
      <div class="sale-info">
        <span class="info-badge">Items: {{ getTotalItems(s) }}</span>
        <span class="info-badge">Total: ₹{{ s.total }}</span>
        <span class="info-badge" [ngClass]="{'profit-positive': getSaleProfit(s) > 0, 'profit-negative': getSaleProfit(s) <= 0}">
          Profit: ₹{{ getSaleProfit(s) | number:'1.0-2' }}
        </span>
        <span class="info-badge">{{ s.paymentMode || 'Cash' }}</span>
      </div>
      <details class="items-details">
        <summary>Items Breakdown</summary>
        <ul>
          <li *ngFor="let i of s.items" style="word-break: break-word;">
            {{ i.name }} x {{ i.qty }} | Cost ₹{{ i.costPrice || 0 }} | Sold ₹{{ i.sellingPrice || i.price }} |
            <strong [ngClass]="{'profit-positive': ((i.sellingPrice || i.price) - (i.costPrice || 0)) * i.qty > 0,
                                 'profit-negative': ((i.sellingPrice || i.price) - (i.costPrice || 0)) * i.qty <= 0}">
              Profit ₹{{ ((i.sellingPrice || i.price) - (i.costPrice || 0)) * i.qty }}
            </strong>
          </li>
        </ul>
      </details>
    </div>

    <!-- Mobile Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button [disabled]="currentPage===1" (click)="goToPage(currentPage-1)">Prev</button>
      <button *ngFor="let p of [].constructor(totalPages); let i = index" 
              [class.active]="currentPage===i+1" (click)="goToPage(i+1)">
        {{ i+1 }}
      </button>
      <button [disabled]="currentPage===totalPages" (click)="goToPage(currentPage+1)">Next</button>
    </div>
  </div>

</div>
