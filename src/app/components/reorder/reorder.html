<div class="low-stock">
  <p-card>
    <div class="page-header">
      <h2>Low Stock Products</h2>
      <p class="page-subtitle">Products that need reordering</p>
    </div>
    <div class="filters mb-2">
  <label>Category:</label>
  <select 
    [(ngModel)]="selectedCategory"
    (change)="loadSubcategories()"
  >
    <option [ngValue]="null" disabled selected>Select Category</option>
    <option *ngFor="let c of categories" [ngValue]="c">
  {{ c.name }}
</option>

  </select>

  <label>Subcategory:</label>
  <select 
    [(ngModel)]="selectedSubcategory"
    (change)="loadProducts()"
  >
    <option [ngValue]="null" selected>All Subcategories</option>
    <option *ngFor="let s of subcategories" [ngValue]="s">
  {{ s.name }}
</option>

  </select>
</div>


    <ng-container *ngIf="!loading; else loadingTpl">
      <ng-container *ngIf="grouped | keyvalue as groupedData; else noDataTpl">
        <div *ngFor="let cat of groupedData" class="category-panel">
          <div
            class="category-header"
            (click)="toggleCategory(cat.key)"
            [class.active]="activeCategory === cat.key"
          >
            <div class="category-title">
              {{ cat.key }}
              <span *ngIf="createdOrders[cat.key]" class="ordered-badge">
                {{ getOrderedQty(cat.key) }} Ordered
              </span>
            </div>
            <i
              class="pi"
              [ngClass]="
                activeCategory === cat.key ? 'pi-chevron-up' : 'pi-chevron-down'
              "
            ></i>
          </div>

          <div
            class="category-body"
            [class.expanded]="activeCategory === cat.key"
          >
            <p-table
              [value]="cat.value"
              [paginator]="true"
              [rows]="10"
              responsiveLayout="scroll"
              [showGridlines]="true"
              class="low-stock-table"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th>Product</th>
                  <th>Stock</th>
                  <th>Min</th>
                  <th>Qty to Order</th>
                  <th>Subcategory (Lowest Price First)</th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-p>
                <tr>
                  <td style="word-break: break-all;">{{ p.name }}</td>
                  <td>{{ p.stock }}</td>
                  <td>{{ p.minStock }}</td>
                  <td>
                    <input
                      type="number"
                      [(ngModel)]="p.orderQty"
                      min="1"
                      [max]="(p.minStock || 5) - (p.stock || 0) + 20"
                      class="p-inputtext qty-input"
                    />
                  </td>
                  <td>{{ p.subCategoryName }}</td>
                </tr>
              </ng-template>
            </p-table>

            <div class="button-container">
              <p-button
                [label]="
                  createdOrders[cat.key]
                    ? ' Ordered (' + getOrderedQty(cat.key) + ' items)'
                    : ' Create Purchase Order'
                "
                [icon]="
                  createdOrders[cat.key]
                    ? 'pi pi-check-circle'
                    : 'pi pi-shopping-cart'
                "
                [ngClass]="
                  createdOrders[cat.key] ? 'p-1 ordered-btn' : 'p-1 create-btn'
                "
                (click)="createOrder(cat.key, cat.value)"
                [disabled]="createdOrders[cat.key]"
              ></p-button>
            </div>
          </div>
        </div>
      </ng-container>
    </ng-container>
  </p-card>
</div>

<ng-template #loadingTpl>
  <div class="loading-container">
    <p>Please choose valid category or sub category</p>
  </div>
</ng-template>

<ng-template #noDataTpl>
  <div class="no-data-container">
    <p>ðŸŽ‰ All products are sufficiently stocked!</p>
  </div>
</ng-template>
