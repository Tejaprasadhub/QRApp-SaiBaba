<div class="purchase-order-wrapper">
  <p-card header="Purchase Orders" class="purchase-orders-card">

    <ng-container *ngIf="purchaseOrders$ | async as orders">
      <ng-container *ngIf="orders.length > 0; else noOrdersTpl">

        <!-- ================= Desktop Table (Web View) ================= -->
        <p-table
          [value]="orders"
          [paginator]="true"
          [rows]="10"
          responsiveLayout="scroll"
          class="purchase-orders-table"
        >
          <ng-template pTemplate="header">
            <tr>
              <th></th>
              <th>S No.</th>
              <th>Date</th>
              <th>Category</th>
              <th>Status</th>
              <th>Items</th>
              <th>Total Received Qty</th>
              <th>Total Received Value</th>
              <th>Actions</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-order let-i="rowIndex">
            <tr>
              <td>
                <p-button
                  label=""
                  icon="{{ isOrderExpanded(order.id) ? 'pi pi-chevron-up' : 'pi pi-chevron-down' }}"
                  class="p-button-sm p-button-secondary"
                  (click)="toggleOrderItems(order.id)"
                ></p-button>
              </td>
              <td><b>{{ i + 1 }}</b></td>
              <td>
                {{
                  order.date?.toDate
                    ? (order.date.toDate() | date: 'medium')
                    : (order.date | date: 'medium')
                }}
              </td>
              <td>{{ order.categoryName }}</td>
              <td>{{ order.status | titlecase }}</td>
              <td>{{ order.items?.length }}</td>
              <td>{{ totalReceived(order) }}</td>
              <td>â‚¹{{ totalReceivedPrice(order) }}</td>
              <td class="d-flex">
                <p-button
                  *ngIf="order.status !== 'completed'"
                  label=""
                  icon="pi pi-print"
                  class="p-button-success p-button-sm"
                  (click)="printPDF(order)"
                ></p-button>

                <p-button
                  *ngIf="order.status !== 'completed'"
                  label=""
                  icon="pi pi-trash"
                  class="p-button-danger p-button-sm"
                  (click)="deleteOrder(order.id)"
                ></p-button>

                <span
                  *ngIf="order.status === 'completed'"
                  class="p-tag p-tag-success inline-item-row"
                  >Completed</span
                >
              </td>
            </tr>

            <!-- Completed order notice -->
            <tr *ngIf="order.status === 'completed'">
              <td colspan="1"></td>
              <td colspan="8">
                <div class="p-tag p-tag-success" style="margin:10px 0;">
                  This purchase order is completed and cannot be edited.
                </div>
              </td>
            </tr>

            <!-- Collapsible items table -->
            <tr *ngIf="isOrderExpanded(order.id)">
              <td colspan="9" class="p-0">
                <div
                  class="items-container"
                  [@slideFadeToggle]
                  style="overflow: hidden; padding: 0 1rem 1rem 1rem;"
                >
                  <!-- ðŸ” NAME SEARCH BOX -->
      <input
        type="text"
        [(ngModel)]="itemSearchMap[order.id]"
        placeholder="Search item by name"
        class="item-search-box"
      />

      <p-table
        [value]="getFilteredItems(order)"
                    [paginator]="true"
                    [rows]="5"
                    [responsiveLayout]="'scroll'"
                    class="nested-items-table"
                  >
                    <ng-template pTemplate="header">
                      <tr>
                        <th>Item Name</th>
                        <th>Ordered Qty</th>
                        <th>Received Qty</th>
                        <th>Price</th>
                        <th>Subcategory</th>
                        <th>Action</th>
                      </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-item>
                      <tr>
                        <td><strong>{{ item.name }}</strong></td>
                        <td>{{ item.orderQty }}</td>
                        <td>
                          <input
                            type="number"
                            [(ngModel)]="getEditingItem(order.id, item).receivedQty"
                            [disabled]="item.received || order.status === 'completed'"
                            class="qty-input"
                          />
                        </td>
                        <td>
                          <input
                            type="number"
                            [(ngModel)]="getEditingItem(order.id, item).newPrice"
                            [disabled]="item.received || order.status === 'completed'"
                            class="price-input"
                          />
                        </td>
                        <td>
                          <input  class="mb-2"
  type="text"
  placeholder="Search subcategories..."
  #search
  class="subcat-filter-input"
/>

                         <select
  [(ngModel)]="getEditingItem(order.id, item).subCategoryId"
  [disabled]="item.received || order.status === 'completed'"
  class="subcategory-input w-100 mt-2"
  (change)="onSubCategoryChange(order.id, item)"
>
  <option value="">Select Subcategory</option>

  <option
    *ngFor="let sub of filterSubcategories(item.categoryId, search.value)"
    [value]="sub.id"
  >
    {{ sub.name }}
  </option>
</select>

                          <div class="lowest-price" *ngIf="getLowestPriceSubName(item)">
                            <small>Lowest Price: {{ getLowestPriceSubName(item) }}</small>
                          </div>
                        </td>
                        <td>
                          <p-button
                            *ngIf="!item.received && order.status !== 'completed'"
                            label="Save & Mark Received"
                            icon="pi pi-check"
                            class="p-button-success p-button-sm"
                            (click)="saveItem(order, item)"
                          ></p-button>

                          <span *ngIf="item.received" class="p-tag p-tag-success">
                            âœ” Received
                          </span>
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>

        <!-- ================= Mobile View Cards ================= -->
        <div class="mobile-orders-list">
          <ng-container *ngFor="let order of orders; let i = index">
            <div class="mobile-order-card">
              <div class="order-header d-block">
                <div class="order-info">
                  <div><strong>#{{ i + 1 }} - {{ order.categoryName }}</strong></div>
                  <div>Date: {{
                    order.date?.toDate ? (order.date.toDate() | date: 'short') : (order.date | date: 'short')
                  }}</div>
                  <div>Status: {{ order.status | titlecase }}</div>
                </div>
                <div class="order-actions">
                  <p-button
                    icon="{{ isOrderExpanded(order.id) ? 'pi pi-chevron-up' : 'pi pi-chevron-down' }}"
                    class="p-button-sm p-button-secondary"
                    (click)="toggleOrderItems(order.id)"
                  ></p-button>

                  <p-button
                    *ngIf="order.status !== 'completed'"
                    icon="pi pi-print"
                    class="p-button-success p-button-sm"
                    (click)="printPDF(order)"
                  ></p-button>

                  <p-button
                    *ngIf="order.status !== 'completed'"
                    icon="pi pi-trash"
                    class="p-button-danger p-button-sm"
                    (click)="deleteOrder(order.id)"
                  ></p-button>

                  <span *ngIf="order.status === 'completed'" class="p-tag p-tag-success">Completed</span>
                </div>
              </div>

              <!-- Collapsible items -->
              <div class="order-items" *ngIf="isOrderExpanded(order.id)">
                <ng-container *ngFor="let item of order.items">
                  <div class="inline-item-row">
                    <div class="item-name">{{ item.name }}</div>
                    <div class="item-order">
                      Ordered: {{ item.orderQty }}
                    </div>
                    <div class="item-received">
                      Received:
                      <input
                        type="number"
                        [(ngModel)]="getEditingItem(order.id, item).receivedQty"
                        [disabled]="item.received || order.status === 'completed'"
                        class="qty-input"
                      />
                    </div>
                    <div class="item-price">
                      Price:
                      <input
                        type="number"
                        [(ngModel)]="getEditingItem(order.id, item).newPrice"
                        [disabled]="item.received || order.status === 'completed'"
                        class="price-input"
                      />
                    </div>
                    <div class="item-subcategory">
                      <select
                        [(ngModel)]="getEditingItem(order.id, item).subCategoryId"
                        [disabled]="item.received || order.status === 'completed'"
                        class="subcategory-input w-100"
                        (change)="onSubCategoryChange(order.id, item)"
                      >
                        <option value="">Select Subcategory</option>
                        <option
                          *ngFor="let sub of getSubsForCategory(item.categoryId)"
                          [value]="sub.id"
                        >
                          {{ sub.name }}
                        </option>
                      </select>
                      <div class="lowest-price" *ngIf="getLowestPriceSubName(item)">
                        <small>Lowest Price: {{ getLowestPriceSubName(item) }}</small>
                      </div>
                    </div>
                    <div class="item-action">
                      <p-button
                        *ngIf="!item.received && order.status !== 'completed'"
                        label="Save & Mark Received"
                        icon="pi pi-check"
                        class="p-button-success p-button-sm"
                        (click)="saveItem(order, item)"
                      ></p-button>
                      <span *ngIf="item.received" class="p-tag p-tag-success">âœ” Received</span>
                    </div>
                  </div>
                </ng-container>
              </div>

              <!-- Completed notice -->
              <div *ngIf="order.status === 'completed'" class="p-tag p-tag-success completed-notice">
                This purchase order is completed and cannot be edited.
              </div>
            </div>
          </ng-container>
        </div>

      </ng-container>
    </ng-container>

    <!-- No Orders Template -->
    <ng-template #noOrdersTpl>
      <div class="no-orders-container">
        <p class="p-text-center p-text-lg">
          ðŸŽ‰ No purchase orders found. All orders are up to date!
        </p>
      </div>
    </ng-template>

  </p-card>
</div>
