<div class="purchase-order-wrapper">
  <p-card header="Purchase Orders" class="purchase-orders-card">
    <!-- Use async as variable for reliable check -->
    <ng-container *ngIf="purchaseOrders$ | async as orders">
      <ng-container *ngIf="orders.length > 0; else noOrdersTpl">
        <p-table
          [value]="orders"
          [paginator]="true"
          [rows]="10"
          responsiveLayout="scroll"
          class="purchase-orders-table"
        >
          <!-- Table Header -->
          <ng-template pTemplate="header">
            <tr>
              <th>Date</th>
              <th>Category</th>
              <th>Status</th>
              <th>Items</th>
              <th>Total Received Qty</th>
              <th>Total Received Value</th>
              <th>Actions</th>
            </tr>
          </ng-template>

          <!-- Table Body -->
          <ng-template pTemplate="body" let-order>
            <tr>
              <td>{{ order.date?.toDate ? (order.date.toDate() | date: 'medium') : (order.date | date: 'medium') }}</td>
              <td>{{ order.categoryName }}</td>
              <td>{{ order.status | titlecase }}</td>
              <td>{{ order.items?.length }}</td>
              <td>{{ totalReceived(order) }}</td>
              <td>â‚¹{{ totalReceivedPrice(order) }}</td>
              <td>
                <p-button
                  label="Delete"
                  icon="pi pi-trash"
                  class="p-button-danger p-button-sm"
                  (click)="deleteOrder(order.id)"
                ></p-button>
              </td>
            </tr>

            <tr *ngFor="let item of order.items">
              <td colspan="7">
                <div class="inline-item-row">
                  <div class="item-name"><strong>{{ item.name }}</strong></div>
                  <div class="item-order">Ordered: {{ item.orderQty }}</div>
                  <div class="item-received">
                    <label>Received:</label>
                    <input
                      type="number"
                      [(ngModel)]="getEditingItem(order.id, item).receivedQty"
                      [disabled]="item.received"
                      class="qty-input"
                    />
                  </div>
                  <div class="item-price">
                    <label>Price:</label>
                    <input
                      type="number"
                      [(ngModel)]="getEditingItem(order.id, item).newPrice"
                      [disabled]="item.received"
                      class="price-input"
                    />
                  </div>
                  <div class="item-action">
                    <p-button
                      *ngIf="!item.received"
                      label="Save & Mark Received"
                      icon="pi pi-check"
                      class="p-button-success p-button-sm"
                      (click)="saveItem(order, item)"
                    ></p-button>
                    <span *ngIf="item.received" class="p-tag p-tag-success">âœ” Received</span>
                  </div>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </ng-container>
    </ng-container>

    <!-- Empty State -->
    <ng-template #noOrdersTpl>
      <div class="no-orders-container">
        <p class="p-text-center p-text-lg">ðŸŽ‰ No purchase orders found. All orders are up to date!</p>
      </div>
    </ng-template>
  </p-card>
</div>
