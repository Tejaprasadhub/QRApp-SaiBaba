<p-card header="Purchase Orders">
  <p-table
    [value]="(purchaseOrders$ | async) ?? []"
    [paginator]="true"
    [rows]="10"
    responsiveLayout="scroll"
  >
    <ng-template pTemplate="header">
      <tr>
        <th>Date</th>
        <th>Category</th>
        <th>Status</th>
        <th>Items</th>
        <th>Total Received Qty</th>
        <th>Total Received Value</th>
        <th>Actions</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-order>
      <tr>
        <td>
          {{ order.date?.toDate ? (order.date.toDate() | date: 'medium') : (order.date | date: 'medium') }}
        </td>
        <td>{{ order.categoryName }}</td>
        <td>{{ order.status | titlecase }}</td>
        <td>{{ order.items?.length }}</td>
        <td>{{ totalReceived(order) }}</td>
        <td>₹{{ totalReceivedPrice(order) }}</td>
        <td>
          <p-button
            label="Delete"
            icon="pi pi-trash"
            class="p-button-danger p-button-sm"
            (click)="deleteOrder(order.id)"
          ></p-button>
        </td>
      </tr>

      <!-- Inline item rows -->
      <tr *ngFor="let item of order.items">
        <td colspan="7">
          <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <div style="min-width: 150px;"><strong>{{ item.name }}</strong></div>
            <div>Ordered: {{ item.orderQty }}</div>
            <div>
              <label>Received:</label>
              <input
                type="number"
                [(ngModel)]="getEditingItem(order.id, item).receivedQty"
                [disabled]="item.received"
                style="width: 60px;"
              />
            </div>
            <div>
              <label>Price:</label>
              <input
                type="number"
                [(ngModel)]="getEditingItem(order.id, item).newPrice"
                [disabled]="item.received"
                style="width: 80px;"
              />
            </div>
            <div>
              <p-button
                *ngIf="!item.received"
                label="Save & Mark Received"
                icon="pi pi-check"
                class="p-button-success p-button-sm"
                (click)="saveItem(order, item)"
              ></p-button>
              <span *ngIf="item.received" class="p-tag p-tag-success">✔ Received</span>
            </div>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>
